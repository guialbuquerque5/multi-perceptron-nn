#include "nn.h"
#define INPUT_SIZE 21
#define HIDDEN_SIZE 18
#define OUT_SIZE 3


NN* makeNN(int input, int hidden, int out) {
  printf("making nn\n");

float temp_inp[INPUT_SIZE*HIDDEN_SIZE] = {-0.5641137361526489,-0.899971067905426,-2.2090556621551514,0.4682562053203583,-0.3679996728897095,-0.43007057905197144,-1.0234620571136475,1.3370977640151978,0.8456063270568848,0.1509246826171875,-1.050950288772583,-0.5914914011955261,0.7394886612892151,-2.2996883392333984,-1.2496767044067383,-0.2527640461921692,-1.1569653749465942,0.2102755457162857,0.2872595191001892,-0.975126326084137,0.6708002686500549,-1.2075605392456055,-0.4842575788497925,-1.479886770248413,1.4969234466552734,-0.8893122673034668,0.4714372158050537,0.6843071579933167,-0.8769260048866272,0.937815248966217,-1.454244613647461,-1.066053032875061,0.14048728346824646,0.49447739124298096,-0.7337591648101807,0.004372409079223871,-1.676865577697754,-0.2928471863269806,0.17224864661693573,-1.4483962059020996,0.8921893835067749,-0.24058708548545837,-1.102434754371643,-1.1605768203735352,0.47407349944114685,-0.04995134100317955,0.6522974371910095,-1.2978647947311401,-1.120130181312561,1.0227478742599487,-1.8679190874099731,-2.2725977897644043,-0.34535232186317444,-0.5490949749946594,0.32782819867134094,0.7397603988647461,1.9042977094650269,-0.7824921011924744,1.0812969207763672,-2.048164129257202,-1.0920404195785522,-0.9783132076263428,1.330116629600525,0.8217807412147522,0.7123733758926392,-1.228513240814209,0.9525156021118164,-1.2485990524291992,-0.5981414914131165,-0.47080206871032715,-0.8867127299308777,-0.7953084111213684,0.5519269108772278,0.536634624004364,0.63127201795578,-0.4284531772136688,0.07936269044876099,-1.1389243602752686,0.9502807259559631,-0.7810643911361694,0.26104217767715454,-0.9224849939346313,-0.5707787275314331,0.6388563513755798,-0.018209271132946014,-0.13167425990104675,-0.8092889189720154,0.6846076846122742,-0.2381725162267685,-0.03210166469216347,1.5101041793823242,-0.3636930286884308,0.2099105715751648,-0.4629601538181305,0.31584304571151733,-1.3332077264785767,0.3715780973434448,-0.21217691898345947,0.7826340794563293,0.40397828817367554,-0.991890549659729,1.107883095741272,-0.4255627393722534,-0.8297915458679199,-1.3998878002166748,1.4594088792800903,0.5740634202957153,-0.4718443751335144,0.46850070357322693,-0.9865652918815613,0.5238776206970215,-1.5938646793365479,0.3067345917224884,2.1392288208007812,-0.6240414381027222,-0.6023119688034058,-0.36090758442878723,0.5957167148590088,1.9171503782272339,1.469405174255371,1.2031761407852173,1.203058123588562,-0.6140665411949158,-0.1134561151266098,-1.1720155477523804,-2.2907626628875732,-0.6563599109649658,1.3111501932144165,0.44774651527404785,0.26270800828933716,0.7488809823989868,-0.803381085395813,-0.19314375519752502,-1.567865014076233,0.017966700717806816,-0.5519989728927612,-0.7111772298812866,2.642233371734619,-0.28143155574798584,0.06693073362112045,-0.03470630198717117,-0.6091890335083008,0.8199065327644348,0.43471837043762207,0.32966455817222595,0.029038529843091965,0.5308709740638733,1.075671911239624,1.5953497886657715,1.8846442699432373,0.014184664934873581,0.3917907178401947,-1.0400930643081665,0.5670353770256042,-1.0797911882400513,-1.3825433254241943,-1.8176361322402954,-0.7205560207366943,-1.915848731994629,0.6553997993469238,0.3947227895259857,-0.2505931854248047,0.3139031231403351,0.2667175233364105,-1.1109638214111328,-0.4963687062263489,0.6326735019683838,0.12989509105682373,-0.05696859210729599,0.8754514455795288,-1.3557428121566772,-1.3803540468215942,-1.874922275543213,0.9123662710189819,0.48973122239112854,-0.6386621594429016,-1.02932608127594,0.4882640540599823,2.2642602920532227,1.0738213062286377,-0.928574800491333,-0.6272969841957092,1.3853259086608887,-1.6328908205032349,-0.327552855014801,1.578693151473999,-0.7915279865264893,-0.07265382260084152,-1.0820324420928955,-0.9240642189979553,-0.2372705340385437,0.45910152792930603,-1.8767762184143066,-0.7921656370162964,-0.031938232481479645,0.3325163424015045,1.9709962606430054,-0.9356739521026611,0.38461384177207947,-1.7533808946609497,1.826842188835144,1.0549061298370361,-0.17609478533267975,-0.49955227971076965,-0.44577041268348694,-0.05064690485596657,-0.9617905020713806,-0.4338248670101166,0.30891871452331543,-0.38153141736984253,1.2138142585754395,-0.6301395297050476,1.5633012056350708,0.2828218340873718,-1.4569472074508667,-1.06516432762146,2.0192794799804688,0.2281121164560318,0.9330984354019165,0.7156890630722046,-1.2566417455673218,0.9435365796089172,-0.7051743865013123,-0.8849872946739197,0.7138612270355225,-1.2417916059494019,-0.08067246526479721,-1.0665096044540405,0.5614175200462341,0.5944117307662964,1.3370740413665771,1.2130624055862427,0.07227369397878647,1.0870400667190552,0.5587478280067444,-0.6210951209068298,1.530920386314392,-0.6514222025871277,1.1830888986587524,0.8862452507019043,1.035203218460083,-0.4540803134441376,0.15627725422382355,0.29929080605506897,0.6642780900001526,0.087848961353302,-1.2671020030975342,1.057293176651001,0.05830060690641403,0.7548330426216125,-0.17540982365608215,0.12738390266895294,0.6915174126625061,0.3161188066005707,1.420474886894226,-0.5781237483024597,-0.5750541687011719,-1.1776883602142334,-0.4210035502910614,-0.7773211002349854,-0.8300154805183411,1.3787955045700073,-1.012015461921692,0.10582075268030167,0.25570136308670044,-1.1115992069244385,0.8339413404464722,-1.4651288986206055,0.6393189430236816,0.5638623237609863,0.4177106022834778,-0.08449232578277588,-1.0546092987060547,0.2307601124048233,-2.143054246902466,0.5414402484893799,0.09029727429151535,1.1377068758010864,0.0894511342048645,-0.26901373267173767,-0.43199408054351807,-0.07180609554052353,-1.0658775568008423,-0.14460554718971252,-0.6374226808547974,0.9761232733726501,0.38571321964263916,1.6690033674240112,0.33829644322395325,1.4829425811767578,-0.2618601322174072,0.2002217322587967,-2.2256240844726562,1.7000013589859009,1.3581633567810059,0.46917712688446045,-0.40686485171318054,-0.5290526747703552,-0.2942976951599121,-0.17328810691833496,0.3730611205101013,-0.9266061782836914,0.03355180472135544,-0.5822912454605103,0.3071507215499878,1.1970062255859375,0.2717650830745697,1.544662594795227,1.218546748161316,0.4697856307029724,0.6661744713783264,-0.06313566118478775,-0.5913276672363281,-0.2071027159690857,-0.27115598320961,-1.2285383939743042,-0.0022417306900024414,-1.7833157777786255,1.4167004823684692,-0.055854879319667816,0.7284739017486572,1.1946661472320557,1.2960196733474731,1.6204360723495483,-1.3944066762924194,-1.532244086265564,-0.8001587390899658,0.17482908070087433,1.261986255645752,0.8110950589179993,0.4939417541027069,1.5043529272079468,1.2311395406723022,-0.17827093601226807,1.9925729036331177,-0.2024286538362503,-0.9548710584640503,-0.3223038911819458,0.4028427302837372,0.00323752430267632,0.748936116695404,0.6682162880897522,1.2638592720031738,-2.0016891956329346,-1.1848195791244507,-0.7110541462898254,0.22445061802864075,-0.35482877492904663,-2.0070104598999023,1.3833237886428833,0.30150124430656433,-1.1853229999542236,2.235833168029785,0.11258330196142197,0.9750246405601501,1.5711181163787842,-0.8725066184997559,-0.3160167932510376,-0.5176083445549011,1.498227834701538,-0.6427397131919861,-0.8902239203453064,1.6628459692001343,0.42206263542175293,-1.3742341995239258,1.4174816608428955,1.161513328552246,0.7458634376525879,0.9828652143478394,-0.7634398341178894,0.13123373687267303,0.36684873700141907,-1.3684511184692383,0.40041205286979675,-2.015468120574951,2.481815814971924,2.1523635387420654,-0.5665179491043091};
float temp_out[OUT_SIZE*HIDDEN_SIZE] = {0.48261022567749023,-1.1660892963409424,-0.040543872863054276,-0.04807906970381737,1.6026856899261475,-2.1298837661743164,0.28857874870300293,-1.6762933731079102,-0.5211547017097473,0.36660218238830566,0.45889535546302795,-0.23200350999832153,-0.13103929162025452,-0.8575219511985779,0.26329630613327026,0.5116568803787231,0.7907324433326721,0.08193419873714447,-1.1321219205856323,-0.6206353902816772,-0.7878351211547852,-0.24982602894306183,-0.21207383275032043,2.315293550491333,0.31243836879730225,0.16705933213233948,-0.5210291743278503,0.8181209564208984,1.1265329122543335,1.0583223104476929,0.753895103931427,-0.6530336141586304,-1.8824928998947144,0.1257282942533493,1.297257661819458,0.2895374000072479,-0.5106046795845032,1.1411807537078857,-1.1712288856506348,0.48314133286476135,0.3354649543762207,1.274354338645935,-0.7376896142959595,-0.3038424253463745,-0.003185599809512496,0.6572287678718567,1.279705286026001,0.42920979857444763,-0.6947063207626343,1.0117297172546387,0.6300113201141357,1.551163673400879,-0.7949948906898499,1.1844662427902222};
float temp_inp_bias[INPUT_SIZE] = {-0.13938161730766296,1.419683814048767,0.8447203636169434,-0.3236822783946991,-0.33981648087501526,-0.5225843191146851,1.4261283874511719,0.3169991075992584,-0.29292693734169006,0.45003294944763184,-1.2036062479019165,1.068344235420227,1.0597753524780273,-0.01241774670779705,2.927912473678589,-0.014984073117375374,1.1039214134216309,-0.524010956287384,-1.547428846359253,0.13837501406669617,0.315815269947052};
float temp_hid_bias[HIDDEN_SIZE] =  {-1.1075005531311035,0.6271670460700989,0.471330851316452,0.041474971920251846,-0.5886874198913574,-0.8831833600997925,-1.3982166051864624,1.5170142650604248,0.15665185451507568,1.3548835515975952,0.8109731078147888,0.6872681975364685,-0.35587918758392334,-1.427370548248291,1.256966471672058,-0.29706257581710815,-1.215573787689209,0.03026711381971836};

  float** inputWeigth =(float**)malloc(sizeof(float*)*INPUT_SIZE);
  for(int i = 0; i < INPUT_SIZE; i++){
    inputWeigth[i] = (float*)malloc(sizeof(float)*HIDDEN_SIZE);
  }

  float** hiddenWeigth =(float**)malloc(sizeof(float*)*HIDDEN_SIZE);
  for(int i = 0; i < HIDDEN_SIZE; i++){
    hiddenWeigth[i] = (float*)malloc(sizeof(float)*OUT_SIZE);
  }
  float** inputBias = (float**)malloc(sizeof(float*));
  inputBias[0] = (float*)malloc(sizeof(float)*INPUT_SIZE);
  
  float** hiddenBias = (float**)malloc(sizeof(float*));
  hiddenBias[0] = (float*)malloc(sizeof(float)*HIDDEN_SIZE);
//MAKING NN
  NN* temp = (NN*)malloc(sizeof(NN));
  temp->inputSize = input;
  temp->hiddenSize = hidden;
  temp->outSize = out;
  
  temp->input = makeMatrix(1, input);
  temp->inputLayer = makeMatrix(input, hidden);
  temp->hiddenLayer = makeMatrix(hidden, out);
  temp->inputBias = makeMatrix(1, input);
  temp->hiddenBias = makeMatrix(1, hidden);

//INIT WEIGTHS
      printf("init init_weigth\n");
printf("input weigth\n");
for(int i = 0; i < INPUT_SIZE; i++){
  for(int j = 0; j < HIDDEN_SIZE; j++){
    inputWeigth[i][j] = temp_inp[i*HIDDEN_SIZE+j];
    }
  }
printf("hidden weigth\n");
  for(int i = 0; i < HIDDEN_SIZE; i++){
    for(int j = 0; j < OUT_SIZE; j++){
      hiddenWeigth[i][j] = temp_out[i*OUT_SIZE+j];
    }
  }
printf("inp bias weigth\n");
  for(int i = 0; i < INPUT_SIZE; i++){
    inputBias[0][i] = temp_inp_bias[i];
  }
printf("hidden bias weigth\n");
  for(int i = 0; i < HIDDEN_SIZE; i++){
    hiddenBias[0][i] = temp_hid_bias[i];
  }

//#########################---SET DATA HERE---#########################
/*
  temp->inputBias = setData_all(temp->inputBias, -1);
  temp->hiddenBias = setData_all(temp->hiddenBias, 1);
  temp->inputLayer = setData_all(temp->inputLayer, 1);
  temp->hiddenLayer = setData_all(temp->hiddenLayer, 1);
*/

  temp->inputBias = setData(temp->inputBias, (float**)inputBias,1,input);
  temp->hiddenBias = setData(temp->hiddenBias, hiddenBias,1,hidden);
  temp->inputLayer = setData(temp->inputLayer, inputWeigth,input,hidden);
  temp->hiddenLayer = setData(temp->hiddenLayer, hiddenWeigth,hidden,out);

  printf("############### Showing data ###############\n");
  show_data(temp->inputBias);
  show_data(temp->hiddenBias);
  show_data(temp->inputLayer);
  show_data(temp->hiddenLayer);
  temp->vision_input = (float*)malloc(sizeof(float) * INPUT_SIZE);

  return temp;
}
void destroyNN(NN* n) {
  destroyMatrix(n->input);
  destroyMatrix(n->inputLayer);
  destroyMatrix(n->hiddenLayer);
  destroyMatrix(n->inputBias);
  destroyMatrix(n->hiddenBias);
  free(n);
}

//set the input matrix of NN with the input vector
void set_input(NN* n, float* in, int inSize) {
  float** temp = (float**)malloc(sizeof(float*) * 1);
  temp[0] = (float*)malloc(sizeof(float) * inSize);
  for (int i = 0; i < inSize; i++) {
    temp[0][i] = in[i];
  }
  n->input = setData(n->input, temp, 1, inSize);
  free(temp[0]);
  free(temp);
}

int predict(float* input, NN* nn) {
  set_input(nn, input, nn->inputSize);
  Matrix* temp_bias = add_matrix(nn->input,nn->inputBias);
  Matrix* temp1 = mat_mult(temp_bias, nn->inputLayer);
  Matrix* temp1_2 = add_matrix(temp1, nn->hiddenBias);
  Matrix* temp2_out = mat_mult(temp1_2, nn->hiddenLayer);
  activate(temp2_out);

  //activation function
  //activate(temp2_out);
  float m = -100;
  int index = 0;
  for (int i = 0; i < nn->outSize; i++) {
    if (temp2_out->data[0][i] > m) {
      m = temp2_out->data[0][i];
      index = i;
    }
  }
  //Serial.println("resultado do predict: " + index);
  destroyMatrix(temp1);
  destroyMatrix(temp2_out);
  return index;
}